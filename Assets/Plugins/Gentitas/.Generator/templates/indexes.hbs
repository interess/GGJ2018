// <auto-generated>
//     This code was generated with love by Gentitas.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>

using Entitas;
using System.Collections.Generic;

{{#each this}}
namespace {{@key}}.Indexes {
	{{#each contexts}}
	namespace {{toUpper name}} {
		{{#each indexes}}
        public interface I{{toUpper name}}Index {
            /// Value: {{valueComponentName}} {{#if flagComponentNames}}| Flags:{{/if}} {{#each flagComponentNames}}{{toUpper this}}{{/each}}
            {{toUpper ../name}}Entity FindSingle({{type}} value);
            /// Value: {{valueComponentName}} {{#if flagComponentNames}}| Flags:{{/if}} {{#each flagComponentNames}}{{toUpper this}}{{/each}}
            HashSet<{{toUpper ../name}}Entity> Find({{type}} value);
            int GetCount({{type}} value);
        }

        public class {{toUpper name}}Index : Entitas.Gentitas.Index<{{type}}, {{toUpper ../name}}Entity>, I{{toUpper name}}Index
        {
            IGroup<{{toUpper ../name}}Entity> groupToWatch;

            public {{toUpper name}}Index(StateContext context) : base()
            {
                groupToWatch = context.GetGroup(Matcher<{{toUpper ../name}}Entity>.AllOf({{toUpper ../name}}Matcher.{{toUpper valueComponentName}}{{#each flagComponentNames}}, {{toUpper ../../name}}Matcher.{{this}}{{/each}}));
                groupToWatch.OnEntityAdded += Added;
                groupToWatch.OnEntityUpdated += Updated;
                groupToWatch.OnEntityRemoved += Removed;
            }

            ~{{toUpper name}}Index () {
                groupToWatch.OnEntityAdded -= Added;
                groupToWatch.OnEntityUpdated -= Updated;
                groupToWatch.OnEntityRemoved -= Removed;
            }

            protected override bool Filter({{toUpper ../name}}Entity entity)
            {
                return entity.Has{{toUpper valueComponentName}}() {{#each flagComponentNames}}&& entity.Has{{this}}(){{/each}};
            }

            void Remove({{toUpper ../name}}Entity entity, {{type}} value) {
                if (lookup.ContainsKey(value))
                {
                    var list = lookup[value];
                    if (list.Contains(entity)) list.Remove(entity);
                }
            }

            void HandleEntity({{toUpper ../name}}Entity entity, {{type}} value)
            {
                if (entity.Has{{toUpper valueComponentName}}()) {
                    if (Filter(entity))
                    {
                        HashSet<{{toUpper ../name}}Entity> result;
                        lookup.TryGetValue(value, out result);
                        if (result == null) {
                            result = new HashSet<{{toUpper ../name}}Entity>();
                            lookup.Add(value, result);
                            result.Add(entity);
                        } else {
                            if (!result.Contains(entity)) result.Add(entity);
                        }
                    }
                    else
                    {
                        Remove(entity, value);
                    }
                } else {
                    Remove(entity, value);
                }
            }

            void HandleEntity({{toUpper ../name}}Entity entity, {{type}} value, {{type}} previousValue)
            {
                if (value != previousValue)
                {
                    Remove(entity, previousValue);
                }
                
                HandleEntity(entity, value);
            }

            void Added(IGroup<{{toUpper ../name}}Entity> group, {{toUpper ../name}}Entity entity, int index, IComponent component)
            {
                HandleEntity(entity, ((Components.{{toUpper ../name}}.{{toUpper valueComponentName}})component).value);
            }

            void Updated(IGroup<{{toUpper ../name}}Entity> group, {{toUpper ../name}}Entity entity, int index, IComponent previousComponent, IComponent component)
            {
                HandleEntity(entity, ((Components.{{toUpper ../name}}.{{toUpper valueComponentName}})component).value, ((Components.{{toUpper ../name}}.{{toUpper valueComponentName}})previousComponent).value);
            }

            void Removed(IGroup<{{toUpper ../name}}Entity> group, {{toUpper ../name}}Entity entity, int index, IComponent component)
            {
                HandleEntity(entity, ((Components.{{toUpper ../name}}.{{toUpper valueComponentName}})component).value);
            }

            public {{toUpper ../name}}Entity FindSingle({{type}} value)
            {
                HashSet<{{toUpper ../name}}Entity> result;
                lookup.TryGetValue(value, out result);

                if (result == null || result.Count == 0) return null;
                if (result.Count > 1) {
                    UnityEngine.Debug.LogError("{{realNamespace}}.{{toUpper name}}Index has more than 1 entity with value " + value);
                    return null;
                }
                
                var enumarator = result.GetEnumerator();
                enumarator.MoveNext();
                
                return enumarator.Current;
            }

            public HashSet<{{toUpper ../name}}Entity> Find({{type}} value)
            {
                HashSet<{{toUpper ../name}}Entity> result;
                lookup.TryGetValue(value, out result);

                if (result == null) {
                    result = lookup[value] = new HashSet<{{toUpper ../name}}Entity>();
                }

                return result;
            }

            public int GetCount({{type}} value)
            {
                HashSet<{{toUpper ../name}}Entity> result;
                lookup.TryGetValue(value, out result);

                if (result == null) return 0;
                return result.Count;
            }
        }
		{{/each}}
	}
	{{/each}}
}
{{/each}}
